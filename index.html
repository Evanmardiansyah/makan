<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nitip Makan Pro V15 (Fixed Bayar)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        :root {
            --primary: #0061a4;
            --bg: #f0f4f8;
            --surface: #ffffff;
            --outline: #73777f;
            --radius: 8px;
        }

        body { font-family: 'Google Sans', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #1f1f1f; font-size: 13px; }
        .container { max-width: 580px; margin: 0 auto; padding-bottom: 60px; }

        .app-header { text-align: center; margin-bottom: 12px; }
        .app-header h1 { color: var(--primary); margin: 0; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .badge { background: #d1e4ff; color: #001d36; padding: 2px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; }

        .card { background: var(--surface); border-radius: 12px; padding: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin-bottom: 10px; border: 1px solid #eef2f6; }
        .card-title { font-size: 13px; font-weight: bold; color: var(--primary); margin-bottom: 8px; display: block; }

        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .m-input { width: 100%; padding: 8px 10px; border: 1px solid var(--outline); border-radius: var(--radius); outline: none; font-family: inherit; transition: 0.2s; font-size: 13px; height: 36px; box-sizing: border-box; }
        .m-input:focus { border-color: var(--primary); border-width: 2px; padding: 7px 9px; }

        .btn { border: none; cursor: pointer; height: 36px; border-radius: var(--radius); font-weight: 500; display: flex; align-items: center; justify-content: center; padding: 0 16px; font-family: inherit; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-icon { background: transparent; color: #ba1a1a; width: 32px; height: 32px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: #ffeceb; }
        .btn-tonal { background: #dbe4f0; color: #001d36; font-size: 11px; height: 28px; padding: 0 12px; }

        .order-item {
            border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; margin-bottom: 6px;
            background: #fff; display: flex; justify-content: space-between; align-items: flex-start;
        }
        .order-left { flex: 1; }
        .name-text { font-weight: bold; color: var(--primary); font-size: 13px; margin-bottom: 2px; }
        
        .edit-area { width: 100%; border: none; background: transparent; font-family: inherit; resize: none; outline: none; padding: 0; line-height: 1.3; }
        .item-text { font-size: 13px; font-weight: 500; color: #333; margin-bottom: 0; }
        .note-text { font-size: 11px; color: #666; font-style: italic; margin-top: 2px; }

        .order-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 0; }
        .price-text { font-weight: bold; font-size: 13px; color: var(--primary); width: 80px; text-align: right; border:none; outline:none; background: transparent;}

        .history-list { margin-top: 8px; max-height: 150px; overflow-y: auto; display: none; }
        .history-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
        th { text-align: left; color: #666; font-size: 10px; text-transform: uppercase; padding: 4px; border-bottom: 1px solid #eee; }
        td { padding: 6px 4px; border-bottom: 1px solid #eee; vertical-align: middle; }

        .stats-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 12px; }
        .stat { padding: 8px; border-radius: 8px; color: white; text-align: center; }
        .bg-o { background: linear-gradient(135deg, #FFB74D, #F57C00); }
        .bg-g { background: linear-gradient(135deg, #81C784, #388E3C); }
        .bg-b { background: linear-gradient(135deg, #64B5F6, #1976D2); }

        @media print { 
            body { padding: 0; font-size: 12px; }
            .no-print { display: none !important; } 
            .card { box-shadow: none; border: 1px solid #ddd; padding: 5px; margin-bottom: 5px; break-inside: avoid; } 
            .order-item { padding: 5px; margin-bottom: 4px; border: 1px solid #eee; }
            .input-row, .btn { display: none; }
            h1 { font-size: 16px; }
        }
    </style>
</head>
<body>

<div class="container" id="app">

    <div class="app-header">
        <h1><span class="material-symbols-rounded" style="font-size:20px;">lunch_dining</span> Nitip Makan Pro</h1>
        <span class="badge">V15 Fixed</span>
    </div>

    <div class="card no-print">
        <div class="input-row">
            <input type="text" class="m-input" id="inName" placeholder="Nama (ex: April)" style="flex:1">
            <input type="text" class="m-input" id="inItem" placeholder="Menu Makanan" style="flex:2">
        </div>
        <div class="input-row">
            <input type="text" class="m-input" id="inNote" placeholder="Catatan" style="flex:2">
            <input type="tel" class="m-input" id="inPrice" placeholder="Harga" style="flex:1" onkeyup="formatRupiah(this)">
            <button class="btn btn-primary" id="btnSubmit" style="width:auto; padding:0 12px;">
                <span class="material-symbols-rounded">send</span>
            </button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label class="card-title" style="margin:0;">Daftar Pesanan</label>
            <button class="btn btn-tonal no-print" onclick="resetAll()">
                <span class="material-symbols-rounded" style="font-size:14px; margin-right:4px;">delete_sweep</span> Reset
            </button>
        </div>
        <div id="loading" style="text-align:center; color:#888; font-size:11px;">Memuat data...</div>
        <div id="orderList"></div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <label class="card-title" style="margin:0;">Kasir</label>
            <div class="no-print" style="font-size:11px;">Tax % <input type="number" id="taxInput" value="0" style="width:35px; border:1px solid #ccc; border-radius:4px; text-align:center;" oninput="renderSummary()"></div>
        </div>

        <table>
            <thead><tr><th width="30%">Nama</th><th style="text-align:right" width="20%">Total</th><th style="text-align:right" width="20%">Bayar</th><th style="text-align:center" width="30%">Status</th></tr></thead>
            <tbody id="summaryBody"></tbody>
        </table>

        <div class="stats-box">
            <div class="stat bg-o"><div style="font-size:9px; opacity:0.8">TAGIHAN</div><div style="font-size:13px; font-weight:bold;" id="txtTotalBill">0</div></div>
            <div class="stat bg-g"><div style="font-size:9px; opacity:0.8">TERKUMPUL</div><div style="font-size:13px; font-weight:bold;" id="txtTotalPaid">0</div></div>
            <div class="stat bg-b"><div style="font-size:9px; opacity:0.8">SISA</div><div style="font-size:13px; font-weight:bold;" id="txtTotalChange">0</div></div>
        </div>
    </div>

    <div class="card no-print" style="background: #fff8e1; border: 1px solid #ffe082;">
        <label class="card-title" style="color:#f57c00;"><span class="material-symbols-rounded" style="vertical-align:middle; font-size:14px;">history</span> Simpan & Riwayat</label>
        <div class="input-row" style="margin-bottom:0;">
            <input type="text" class="m-input" id="historyTitle" placeholder="Judul Sesi" style="background:white; font-size:12px;">
            <button class="btn btn-primary" onclick="saveHistory()" style="background:#f57c00; white-space:nowrap; font-size:12px;">Simpan</button>
        </div>
        <button class="btn btn-tonal" style="width:100%; margin-top:8px; height:28px;" onclick="toggleHistory()">Buka Riwayat</button>
        <div id="historyListContainer" class="history-list"></div>
    </div>

    <div class="card no-print" style="background:#e8def8; display:flex; align-items:center; gap:8px; padding:8px;">
        <span class="material-symbols-rounded" style="font-size:18px;">credit_card</span>
        <input type="text" id="rekInfo" placeholder="Info Rekening..." oninput="saveRek()" style="border:none; background:transparent; width:100%; font-weight:bold; color:#1d192b; outline:none; font-size:12px;">
    </div>

    <div class="no-print" style="text-align:center; display:flex; gap:8px; justify-content:center;">
        <button class="btn btn-tonal" style="background:#25D366; color:white;" onclick="copyWA()">WA</button>
        <button class="btn btn-tonal" style="background:#ba1a1a; color:white;" onclick="downloadPDF()">PDF</button>
        <button class="btn btn-tonal" onclick="window.print()">Print</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://ramoxhufekztfngfwiwm.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_czTPuVoyDqvlxOdpHrgwaw_iSnDhgsP';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
    let globalOrders = [];

    const formatRupiah = (el) => { let v=el.value.replace(/[^0-9]/g,''); el.value=v?parseInt(v).toLocaleString('id-ID'):""; };
    const cleanNum = (v) => typeof v==='number'?v:parseFloat(v?.toString().replace(/\./g,'')||0);
    const autoResize = (el) => { el.style.height='auto'; el.style.height=el.scrollHeight+'px'; };

    async function fetchOrders() {
        const { data } = await db.from('orders').select('*').order('name', {ascending:true}).order('created_at', {ascending:true});
        if(data) { globalOrders = data; renderList(); renderSummary(); document.getElementById('loading').style.display = 'none'; }
    }

    db.channel('any').on('postgres_changes', {event:'*', schema:'public', table:'orders'}, fetchOrders).subscribe();

    document.getElementById('btnSubmit').addEventListener('click', async () => {
        const name = document.getElementById('inName').value;
        const item = document.getElementById('inItem').value;
        const note = document.getElementById('inNote').value;
        const price = cleanNum(document.getElementById('inPrice').value);
        if(!name || !item) return alert("Isi nama dan menu!");
        await db.from('orders').insert({name, item, note, price});
        document.getElementById('inItem').value=''; document.getElementById('inNote').value=''; document.getElementById('inPrice').value=''; document.getElementById('inItem').focus();
    });

    window.updateData = async (id, col, val) => await db.from('orders').update({[col]:val}).eq('id', id);
    window.delOrder = async (id) => { if(confirm("Hapus?")) await db.from('orders').delete().eq('id', id); };
    window.resetAll = async () => { if(confirm("Reset semua?")) await db.from('orders').delete().neq('id', 0); };

    function renderList() {
        const c = document.getElementById('orderList'); c.innerHTML='';
        if(globalOrders.length===0) return c.innerHTML='<div style="text-align:center; padding:10px; color:#999; font-size:11px;">Belum ada pesanan.</div>';
        globalOrders.forEach(o => {
            const div = document.createElement('div');
            div.className = 'order-item';
            div.innerHTML = `
                <div class="order-left">
                    <div class="name-text">${o.name}</div>
                    <textarea class="edit-area item-text" rows="1" oninput="autoResize(this)" onchange="updateData(${o.id},'item',this.value)">${o.item}</textarea>
                    <textarea class="edit-area note-text" rows="1" placeholder="+catatan" oninput="autoResize(this)" onchange="updateData(${o.id},'note',this.value)">${o.note||''}</textarea>
                </div>
                <div class="order-right">
                    <input type="text" class="price-text" value="${o.price.toLocaleString('id-ID')}" onkeyup="formatRupiah(this)" onchange="updateData(${o.id},'price',cleanNum(this.value))">
                    <button class="btn-icon no-print" onclick="delOrder(${o.id})"><span class="material-symbols-rounded" style="font-size:16px;">delete</span></button>
                </div>`;
            c.appendChild(div);
            setTimeout(()=> { autoResize(div.querySelector('.item-text')); autoResize(div.querySelector('.note-text')); }, 50);
        });
    }

    window.renderSummary = function() {
        const tax = parseFloat(document.getElementById('taxInput').value)||0;
        const tb = document.getElementById('summaryBody'); tb.innerHTML='';
        let grp={}, tBill=0, tPaid=0;

        globalOrders.forEach(o => {
            let k=o.name.toLowerCase();
            if(!grp[k]) grp[k]={name:o.name, t:0, p:0, ids:[]};
            grp[k].t+=o.price; 
            grp[k].p+=o.paid||0; 
            grp[k].ids.push(o.id);
        });

        for(let k in grp) {
            let p=grp[k], bill=p.t*(1+tax/100);
            tBill+=bill; tPaid+=p.p;
            let diff = p.p - bill;
            let sts = (p.p > 0) ? (diff >= 0 ? `<span style="color:green; font-weight:bold; font-size:11px;">Kembali Rp ${diff.toLocaleString('id-ID')}</span>` : `<span style="color:red; font-weight:bold; font-size:11px;">Kurang Rp ${Math.abs(diff).toLocaleString('id-ID')}</span>`) : `<span style="color:#ccc; font-size:11px;">Belum Bayar</span>`;
            
            tb.innerHTML += `<tr>
                <td>${p.name}</td>
                <td align="right">${bill.toLocaleString('id-ID')}</td>
                <td align="right"><input type="text" value="${p.p > 0 ? p.p.toLocaleString('id-ID') : ''}" style="width:65px; text-align:right; border:1px solid #ddd; border-radius:4px; font-size:11px; padding:2px;" onkeyup="formatRupiah(this)" onchange="upPay('${p.ids.join(',')}', cleanNum(this.value))"></td>
                <td align="center">${sts}</td>
            </tr>`;
        }
        document.getElementById('txtTotalBill').innerText = tBill.toLocaleString('id-ID');
        document.getElementById('txtTotalPaid').innerText = tPaid.toLocaleString('id-ID');
        document.getElementById('txtTotalChange').innerText = (tPaid-tBill).toLocaleString('id-ID');
    }

    // --- FIX: LOGIKA BAYAR DIBAGI RATA ---
    window.upPay = async (idsString, totalPaid) => {
        const ids = idsString.split(',');
        const splitValue = totalPaid / ids.length;
        for(let id of ids) {
            await db.from('orders').update({paid: splitValue}).eq('id', id);
        }
        fetchOrders();
    };

    async function saveHistory() {
        const title = document.getElementById('historyTitle').value;
        if(!title || globalOrders.length===0) return alert("Data kosong!");
        await db.from('history_sessions').insert({ title, orders_snapshot: globalOrders, total_bill: cleanNum(document.getElementById('txtTotalBill').innerText) });
        alert("Disimpan!"); document.getElementById('historyTitle').value='';
    }

    window.toggleHistory = () => { const el=document.getElementById('historyListContainer'); el.style.display=(el.style.display==='block'?'none':'block'); if(el.style.display==='block') loadHistoryList(); };

    async function loadHistoryList() {
        const { data } = await db.from('history_sessions').select('*').order('created_at', {ascending:false});
        const c = document.getElementById('historyListContainer'); c.innerHTML = '';
        data?.forEach(h => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `<div><strong>${h.title}</strong><br><small>${new Date(h.created_at).toLocaleDateString()}</small></div>
                <button class="btn btn-tonal" onclick="loadSnapshot(${h.id})">Load</button>`;
            c.appendChild(div);
        });
    }

    window.loadSnapshot = async (id) => {
        if(!confirm("Timpah data?")) return;
        const { data } = await db.from('history_sessions').select('orders_snapshot').eq('id', id).single();
        if(data) {
            await db.from('orders').delete().neq('id', 0);
            await db.from('orders').insert(data.orders_snapshot.map(o => ({name:o.name, item:o.item, note:o.note, price:o.price, paid:o.paid||0})));
        }
    };

    window.saveRek = () => localStorage.setItem('rek', document.getElementById('rekInfo').value);
    if(localStorage.getItem('rek')) document.getElementById('rekInfo').value = localStorage.getItem('rek');
    
    window.copyWA = () => {
        let txt = "*LIST PESANAN*\n------------------\n";
        let grp={};
        globalOrders.forEach(o=>{ let k=o.name.toLowerCase(); if(!grp[k])grp[k]={n:o.name,i:[],t:0}; grp[k].i.push(`${o.item} (${o.price/1000}k)`); grp[k].t+=o.price; });
        for(let k in grp) txt+=`*${grp[k].n}*: ${grp[k].t.toLocaleString('id-ID')}\n  ${grp[k].i.join(', ')}\n`;
        txt+=`*TOTAL: ${document.getElementById('txtTotalBill').innerText}*\nRek: ${document.getElementById('rekInfo').value}`;
        navigator.clipboard.writeText(txt).then(()=>alert("Disalin!"));
    };
    window.downloadPDF = () => html2pdf().from(document.getElementById('app')).save('Rekap.pdf');
    fetchOrders();
</script>
</body>
</html>
