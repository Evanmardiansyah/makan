<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nitip Makan Pro V14 (History Edition)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        :root {
            --primary: #0061a4;
            --bg: #f0f4f8;
            --surface: #ffffff;
            --outline: #73777f;
            --radius: 12px;
        }

        body { font-family: 'Google Sans', sans-serif; background: var(--bg); margin: 0; padding: 16px; color: #1f1f1f; }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 80px; }

        /* HEADER */
        .app-header { text-align: center; margin-bottom: 20px; }
        .app-header h1 { color: var(--primary); margin: 0; font-size: 22px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .badge { background: #d1e4ff; color: #001d36; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; }

        /* CARDS */
        .card { background: var(--surface); border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid #eef2f6; }
        .card-title { font-size: 14px; font-weight: bold; color: var(--primary); margin-bottom: 12px; display: block; }

        /* INPUTS */
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .m-input { width: 100%; padding: 12px; border: 1px solid var(--outline); border-radius: var(--radius); outline: none; font-family: inherit; transition: 0.2s; }
        .m-input:focus { border-color: var(--primary); border-width: 2px; padding: 11px; }

        /* BUTTONS */
        .btn { border: none; cursor: pointer; height: 44px; border-radius: var(--radius); font-weight: 500; display: flex; align-items: center; justify-content: center; padding: 0 20px; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-icon { background: transparent; color: #ba1a1a; width: 40px; height: 40px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: #ffeceb; }
        .btn-tonal { background: #dbe4f0; color: #001d36; font-size: 12px; height: 32px; padding: 0 16px; }

        /* ORDER LIST (UI SEPERTI REQUEST) */
        .order-item {
            border: 1px solid #e0e0e0; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px;
            background: #fff; display: flex; justify-content: space-between; align-items: flex-start;
        }
        .order-left { flex: 1; }
        .name-text { font-weight: bold; color: var(--primary); font-size: 15px; margin-bottom: 4px; }
        
        .edit-area { width: 100%; border: none; background: transparent; font-family: inherit; resize: none; outline: none; padding: 0; }
        .item-text { font-size: 15px; font-weight: 500; color: #333; margin-bottom: 2px; }
        .note-text { font-size: 12px; color: #666; font-style: italic; }

        .order-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .price-text { font-weight: bold; font-size: 15px; color: var(--primary); width: 80px; text-align: right; border:none; outline:none;}

        /* HISTORY SECTION */
        .history-controls { display: flex; gap: 8px; margin-top: 10px; }
        .history-list { margin-top: 10px; max-height: 200px; overflow-y: auto; display: none; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .history-item:last-child { border: none; }
        
        /* SUMMARY TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { text-align: left; color: #666; font-size: 11px; text-transform: uppercase; padding: 8px 4px; border-bottom: 1px solid #eee; }
        td { padding: 8px 4px; border-bottom: 1px solid #eee; }

        /* STATS BOX */
        .stats-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 16px; }
        .stat { padding: 12px; border-radius: 12px; color: white; text-align: center; }
        .bg-o { background: linear-gradient(135deg, #FFB74D, #F57C00); }
        .bg-g { background: linear-gradient(135deg, #81C784, #388E3C); }
        .bg-b { background: linear-gradient(135deg, #64B5F6, #1976D2); }

        @media print { .no-print { display: none !important; } .card { box-shadow: none; border: 1px solid #ddd; } }
    </style>
</head>
<body>

<div class="container" id="app">

    <div class="app-header">
        <h1><span class="material-symbols-rounded">lunch_dining</span> Nitip Makan Pro</h1>
        <span class="badge">V14 History Edition</span>
    </div>

    <div class="card no-print">
        <label class="card-title">Tambah Pesanan</label>
        <div class="input-row">
            <input type="text" class="m-input" id="inName" placeholder="Nama (ex: April)" style="flex:1">
            <input type="text" class="m-input" id="inItem" placeholder="Menu Makanan" style="flex:2">
        </div>
        <div class="input-row">
            <input type="text" class="m-input" id="inNote" placeholder="Catatan (Opsional)" style="flex:2">
            <input type="tel" class="m-input" id="inPrice" placeholder="Harga" style="flex:1" onkeyup="formatRupiah(this)">
            <button class="btn btn-primary" id="btnSubmit" style="width:auto; padding:0 16px;">
                <span class="material-symbols-rounded">send</span>
            </button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <label class="card-title" style="margin:0; font-size:16px;">Daftar Pesanan</label>
            <button class="btn btn-tonal no-print" onclick="resetAll()">
                <span class="material-symbols-rounded" style="font-size:16px; margin-right:4px;">delete_sweep</span> Reset
            </button>
        </div>
        
        <div id="loading" style="text-align:center; color:#888;">Memuat data...</div>
        <div id="orderList"></div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <label class="card-title" style="margin:0;">Kasir</label>
            <div class="no-print" style="font-size:12px;">Tax % <input type="number" id="taxInput" value="0" style="width:40px; border:1px solid #ccc; border-radius:4px; text-align:center;" oninput="renderSummary()"></div>
        </div>

        <table>
            <thead><tr><th>Nama</th><th style="text-align:right">Total</th><th style="text-align:right">Bayar</th><th>Sts</th></tr></thead>
            <tbody id="summaryBody"></tbody>
        </table>

        <div class="stats-box">
            <div class="stat bg-o">
                <div style="font-size:10px;">TAGIHAN</div>
                <div style="font-size:14px; font-weight:bold;" id="txtTotalBill">0</div>
            </div>
            <div class="stat bg-g">
                <div style="font-size:10px;">TERKUMPUL</div>
                <div style="font-size:14px; font-weight:bold;" id="txtTotalPaid">0</div>
            </div>
            <div class="stat bg-b">
                <div style="font-size:10px;">SISA</div>
                <div style="font-size:14px; font-weight:bold;" id="txtTotalChange">0</div>
            </div>
        </div>
    </div>

    <div class="card no-print" style="background: #fff8e1; border: 1px solid #ffe082;">
        <label class="card-title" style="color:#f57c00;"><span class="material-symbols-rounded" style="vertical-align:middle; font-size:16px;">history</span> Simpan & Riwayat</label>
        <div style="font-size:12px; color:#666; margin-bottom:8px;">Simpan sesi ini agar bisa dilihat lagi nanti.</div>
        
        <div class="input-row">
            <input type="text" class="m-input" id="historyTitle" placeholder="Judul Sesi (ex: Makan Siang Jumat)" style="background:white;">
            <button class="btn btn-primary" onclick="saveHistory()" style="background:#f57c00; white-space:nowrap;">Simpan Sesi</button>
        </div>

        <button class="btn btn-tonal" style="width:100%; margin-top:8px;" onclick="toggleHistory()">
            Lihat Riwayat Tersimpan
        </button>

        <div id="historyListContainer" class="history-list">
            </div>
    </div>

    <div class="card no-print" style="background:#e8def8; display:flex; align-items:center; gap:10px;">
        <span class="material-symbols-rounded">credit_card</span>
        <input type="text" id="rekInfo" placeholder="Info Rekening (Klik untuk edit)..." oninput="saveRek()" 
            style="border:none; background:transparent; width:100%; font-weight:bold; color:#1d192b; outline:none;">
    </div>

    <div class="no-print" style="text-align:center; display:flex; gap:10px; justify-content:center;">
        <button class="btn btn-tonal" style="background:#25D366; color:white;" onclick="copyWA()">WA</button>
        <button class="btn btn-tonal" style="background:#ba1a1a; color:white;" onclick="downloadPDF()">PDF</button>
        <button class="btn btn-tonal" onclick="window.print()">Print</button>
    </div>

</div>

<script>
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://ramoxhufekztfngfwiwm.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_czTPuVoyDqvlxOdpHrgwaw_iSnDhgsP';

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let globalOrders = [];

    // --- HELPERS ---
    const formatRupiah = (el) => { let v=el.value.replace(/[^0-9]/g,''); el.value=v?parseInt(v).toLocaleString('id-ID'):""; };
    const cleanNum = (v) => typeof v==='number'?v:parseFloat(v?.replace(/\./g,'')||0);
    const autoResize = (el) => { el.style.height='auto'; el.style.height=el.scrollHeight+'px'; };

    // --- CORE ---
    async function fetchOrders() {
        const { data, error } = await db.from('orders').select('*').order('name', {ascending:true}).order('created_at', {ascending:true});
        if(data) {
            globalOrders = data;
            renderList();
            renderSummary();
            document.getElementById('loading').style.display = 'none';
        }
    }

    // Subscribe Realtime
    db.channel('any').on('postgres_changes', {event:'*', schema:'public', table:'orders'}, fetchOrders).subscribe();

    // Submit
    document.getElementById('btnSubmit').addEventListener('click', async () => {
        const name = document.getElementById('inName').value;
        const item = document.getElementById('inItem').value;
        const note = document.getElementById('inNote').value;
        const price = cleanNum(document.getElementById('inPrice').value);
        if(!name || !item) return alert("Isi nama dan menu!");
        
        await db.from('orders').insert({name, item, note, price});
        document.getElementById('inItem').value=''; document.getElementById('inNote').value=''; document.getElementById('inPrice').value=''; document.getElementById('inItem').focus();
    });

    window.updateData = async (id, col, val) => await db.from('orders').update({[col]:val}).eq('id', id);
    window.delOrder = async (id) => { if(confirm("Hapus?")) await db.from('orders').delete().eq('id', id); };
    window.resetAll = async () => { if(confirm("Reset semua?")) await db.from('orders').delete().neq('id', 0); };

    // --- RENDER UI CLASSIC ---
    function renderList() {
        const c = document.getElementById('orderList'); c.innerHTML='';
        if(globalOrders.length===0) return c.innerHTML='<div style="text-align:center; padding:10px; color:#999">Kosong.</div>';

        globalOrders.forEach(o => {
            const div = document.createElement('div');
            div.className = 'order-item';
            div.innerHTML = `
                <div class="order-left">
                    <div class="name-text">${o.name}</div>
                    <textarea class="edit-area item-text" rows="1" oninput="autoResize(this)" onchange="updateData(${o.id},'item',this.value)">${o.item}</textarea>
                    <textarea class="edit-area note-text" rows="1" placeholder="+catatan" oninput="autoResize(this)" onchange="updateData(${o.id},'note',this.value)">${o.note||''}</textarea>
                </div>
                <div class="order-right">
                    <input type="text" class="price-text" value="${o.price.toLocaleString('id-ID')}" onkeyup="formatRupiah(this)" onchange="updateData(${o.id},'price',cleanNum(this.value))">
                    <button class="btn-icon no-print" onclick="delOrder(${o.id})">
                        <span class="material-symbols-rounded">delete</span>
                    </button>
                </div>
            `;
            c.appendChild(div);
            setTimeout(()=>{ autoResize(div.querySelector('.item-text')); autoResize(div.querySelector('.note-text')); },50);
        });
    }

    // --- SUMMARY ---
    window.renderSummary = function() {
        const tax = parseFloat(document.getElementById('taxInput').value)||0;
        const tb = document.getElementById('summaryBody'); tb.innerHTML='';
        let grp={}, tBill=0, tPaid=0;

        globalOrders.forEach(o => {
            let k=o.name.toLowerCase();
            if(!grp[k]) grp[k]={name:o.name, t:0, p:0, ids:[]};
            grp[k].t+=o.price; grp[k].p+=(o.paid||0); grp[k].ids.push(o.id);
        });

        for(let k in grp) {
            let p=grp[k], bill=p.t*(1+tax/100);
            tBill+=bill; tPaid+=p.p;
            let diff=p.p-bill, sts = p.p>0 ? (diff>=0?`<span style="color:green;font-weight:bold">OK</span>`:`<span style="color:red;font-weight:bold">-${Math.abs(diff).toLocaleString('id-ID')}</span>`) : '-';
            
            tb.innerHTML += `<tr>
                <td>${p.name}</td>
                <td align="right">${bill.toLocaleString('id-ID')}</td>
                <td align="right"><input type="text" value="${p.p>0?p.p.toLocaleString('id-ID'):''}" style="width:60px;text-align:right;border:1px solid #ddd;" onkeyup="formatRupiah(this)" onchange="upPay('${grp[k].ids}',cleanNum(this.value))"></td>
                <td align="center">${sts}</td>
            </tr>`;
        }
        document.getElementById('txtTotalBill').innerText = tBill.toLocaleString('id-ID');
        document.getElementById('txtTotalPaid').innerText = tPaid.toLocaleString('id-ID');
        document.getElementById('txtTotalChange').innerText = (tPaid-tBill).toLocaleString('id-ID');
    }
    window.upPay = async (ids, val) => { for(let id of ids.split(',')) await db.from('orders').update({paid:val}).eq('id',id); fetchOrders(); };

    // --- FITUR HISTORY ---
    async function saveHistory() {
        const title = document.getElementById('historyTitle').value;
        if(!title || globalOrders.length===0) return alert("Judul kosong atau pesanan kosong!");
        
        // Simpan snapshot JSON
        const snapshot = JSON.stringify(globalOrders);
        const total = cleanNum(document.getElementById('txtTotalBill').innerText);

        const { error } = await db.from('history_sessions').insert({ title, orders_snapshot: globalOrders, total_bill: total });
        if(error) alert("Gagal simpan: "+error.message);
        else { alert("Berhasil disimpan!"); document.getElementById('historyTitle').value=''; loadHistoryList(); }
    }

    async function toggleHistory() {
        const el = document.getElementById('historyListContainer');
        if(el.style.display === 'block') el.style.display = 'none';
        else { el.style.display = 'block'; loadHistoryList(); }
    }

    async function loadHistoryList() {
        const { data } = await db.from('history_sessions').select('*').order('created_at', {ascending:false});
        const c = document.getElementById('historyListContainer'); c.innerHTML = '';
        if(!data || data.length===0) return c.innerHTML='<div style="padding:10px;">Belum ada riwayat.</div>';

        data.forEach(h => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div>
                    <strong>${h.title}</strong><br>
                    <span style="color:#888;">${new Date(h.created_at).toLocaleDateString()} - Rp ${h.total_bill?.toLocaleString('id-ID') || 0}</span>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-tonal" style="height:28px; font-size:11px;" onclick="loadSnapshot(${h.id})">Lihat</button>
                    <button class="btn-icon" style="width:28px; height:28px; font-size:16px;" onclick="delHistory(${h.id})"><span class="material-symbols-rounded">delete</span></button>
                </div>
            `;
            c.appendChild(div);
        });
    }

    window.loadSnapshot = async (id) => {
        if(!confirm("Tampilkan sesi ini di papan? (Data sekarang akan ditimpa)")) return;
        const { data } = await db.from('history_sessions').select('orders_snapshot').eq('id', id).single();
        if(data) {
            // Hapus data sekarang dulu
            await db.from('orders').delete().neq('id', 0);
            // Insert data lama (Bulk insert)
            // Kita perlu buang ID lama biar digenerate baru, dan reset timestamp
            const items = data.orders_snapshot.map(o => ({
                name: o.name, item: o.item, note: o.note, price: o.price, paid: o.paid || 0
            }));
            await db.from('orders').insert(items);
            alert("Data berhasil dimuat ulang!");
        }
    };

    window.delHistory = async (id) => { if(confirm("Hapus riwayat ini?")) { await db.from('history_sessions').delete().eq('id', id); loadHistoryList(); }};

    // --- OTHER ---
    window.saveRek = () => localStorage.setItem('rek', document.getElementById('rekInfo').value);
    if(localStorage.getItem('rek')) document.getElementById('rekInfo').value = localStorage.getItem('rek');
    
    window.copyWA = () => {
        let txt = "*LIST PESANAN*\n------------------\n";
        let grp={};
        globalOrders.forEach(o=>{ let k=o.name.toLowerCase(); if(!grp[k])grp[k]={n:o.name,i:[],t:0}; grp[k].i.push(`${o.item} (${o.price/1000}k)`); grp[k].t+=o.price; });
        for(let k in grp) txt+=`*${grp[k].n}*: ${grp[k].t.toLocaleString('id-ID')}\n  ${grp[k].i.join(', ')}\n`;
        txt+=`\n*TOTAL: ${document.getElementById('txtTotalBill').innerText}*`;
        if(document.getElementById('rekInfo').value) txt+=`\nBayar: ${document.getElementById('rekInfo').value}`;
        navigator.clipboard.writeText(txt).then(()=>alert("Disalin ke WA!"));
    };
    window.downloadPDF = () => html2pdf().from(document.getElementById('app')).save('Rekap.pdf');

    fetchOrders();
</script>

</body>
</html>
